<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BombusLab Map</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Helvetica Neue', Arial, sans-serif; display: flex; flex-direction: column; height: 100vh; background-color: #f0f0f0; }
        .header { background-color: #ffffff; padding: 10px 15px; display: flex; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 1000; flex-shrink: 0; }
        .header-logo { width: 40px; height: 40px; margin-right: 12px; border-radius: 50%; object-fit: cover; border: 2px solid #ffcc00; }
        .header-text { font-size: 15px; font-weight: 700; color: #333; line-height: 1.2; }
        #map { flex-grow: 1; width: 100%; z-index: 1; }
        #form { padding: 15px; background: #fff; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 10px; max-height: 45vh; overflow-y: auto; z-index: 2; }
        h3 { margin: 0 0 5px 0; font-size: 16px; text-align: center; color: #444; }
        input, button { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 14px; outline: none; }
        input:focus { border-color: #ffcc00; }
        button { background-color: #ffcc00; border: none; font-weight: bold; cursor: pointer; color: #222; }
        button:disabled { background-color: #eee; color: #999; cursor: wait; }
        label { font-size: 12px; color: #666; margin-bottom: -5px; display: block; font-weight: 500; }
        #status { font-size: 12px; text-align: center; color: #e53935; min-height: 15px; font-weight: bold; }
        .leaflet-control-attribution a { text-decoration: none; color: #666; pointer-events: none; }
        .leaflet-control-attribution { font-size: 10px; color: #999; }
        /* –°—Ç–∏–ª—å –¥–ª—è –ø–æ–ø–∞–ø–∞ */
        .custom-popup img { width: 100%; border-radius: 5px; margin-top: 5px; }
        .custom-popup b { color: #333; }
    </style>
</head>
<body>

    <div class="header">
        <img src="https://i.ibb.co/39rvJB7r/IMG-20251214-001527.png" alt="Logo" class="header-logo">
        <div class="header-text">
            BombusLab<br>
            <span style="font-size: 12px; font-weight: 400; color: #666;">–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞</span>
        </div>
    </div>

    <div id="map"></div>

    <div id="form">
        <h3>üìç –î–æ–±–∞–≤–∏—Ç—å –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ</h3>
        <div><label>üìÖ –î–∞—Ç–∞ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è:</label><input type="date" id="dateInput"></div>
        <div><label>üêù –í–∏–¥ —à–º–µ–ª—è:</label><input type="text" id="species" placeholder="–ù–∞–ø—Ä. Bombus terrestris"></div>
        <div><label>üì∏ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è:</label><input type="file" id="photoInput" accept="image/*"></div>
        <div id="status"></div>
        <button id="sendBtn">–û–¢–ü–†–ê–í–ò–¢–¨ –ò –°–û–•–†–ê–ù–ò–¢–¨</button>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Firebase –∫–∞–∫ –º–æ–¥—É–ª—å -->
    <script type="module">
        // ==========================================
        // ‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò (–ó–ê–ü–û–õ–ù–ò–¢–ï –ó–î–ï–°–¨)
        // ==========================================
        const IMGBB_API_KEY = 'fd4fb53d5092582ee37e584006e297e6'; 
        
        // –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –í–ï–°–¨ –ë–õ–û–ö firebaseConfig –ò–ó –ö–û–ù–°–û–õ–ò FIREBASE
        const firebaseConfig = {
        apiKey: "AIzaSyBNiyinqp09FYDHVkhFBul2elTGFiLyxao",
        authDomain: "bombus-map.firebaseapp.com",
        projectId: "bombus-map",
        storageBucket: "bombus-map.firebasestorage.app",
        messagingSenderId: "469275831180",
        appId: "1:469275831180:web:7368912788e34ff02084a9"
};
        // ==========================================

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let tg = window.Telegram.WebApp;
        tg.expand(); 

        // –ö–∞—Ä—Ç–∞
        var map = L.map('map', { attributionControl: false }).setView([55.75, 37.61], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Map data &copy; OpenStreetMap' }).addTo(map);
        L.control.attribution({ prefix: false }).addTo(map);

        var marker;
        var selectedLat, selectedLng;
        document.getElementById('dateInput').valueAsDate = new Date();

        // --- –ó–ê–ì–†–£–ó–ö–ê –¢–û–ß–ï–ö –ò–ó –ë–ê–ó–´ ---
        async function loadMarkers() {
            try {
                const querySnapshot = await getDocs(collection(db, "markers"));
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // –°–æ–∑–¥–∞–µ–º –∫—Ä–∞—Å–∏–≤—ã–π –º–∞—Ä–∫–µ—Ä –¥–ª—è –∫–∞–∂–¥–æ–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π —Ç–æ—á–∫–∏
                    const popupContent = `
                        <div class="custom-popup">
                            <b>${data.species}</b><br>
                            üìÖ ${data.date}<br>
                            <img src="${data.photo}" alt="–§–æ—Ç–æ">
                        </div>
                    `;
                    L.marker([data.lat, data.lng]).addTo(map).bindPopup(popupContent);
                });
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã:", e);
            }
        }
        loadMarkers(); // –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Å—Ä–∞–∑—É

        // --- –ì–ï–û–õ–û–ö–ê–¶–ò–Ø –ò –í–´–ë–û–† –¢–û–ß–ö–ò ---
        map.locate({setView: true, maxZoom: 10});
        map.on('locationfound', function(e) { updateNewMarker(e.latlng); });
        map.on('click', function(e) { updateNewMarker(e.latlng); });

        function updateNewMarker(latlng) {
            if (marker) map.removeLayer(marker);
            // –ö—Ä–∞—Å–Ω—ã–π –º–∞—Ä–∫–µ—Ä –¥–ª—è "–Ω–æ–≤–æ–π" —Ç–æ—á–∫–∏
            marker = L.marker(latlng).addTo(map).bindPopup("–ù–æ–≤–æ–µ –º–µ—Å—Ç–æ").openPopup();
            selectedLat = latlng.lat;
            selectedLng = latlng.lng;
        }

        // --- –û–¢–ü–†–ê–í–ö–ê –î–ê–ù–ù–´–• ---
        document.getElementById('sendBtn').addEventListener('click', async () => {
            const statusDiv = document.getElementById('status');
            const btn = document.getElementById('sendBtn');
            const fileInput = document.getElementById('photoInput');
            const species = document.getElementById('species').value || "–ù–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω";
            const date = document.getElementById('dateInput').value;

            if (!selectedLat) { statusDiv.innerText = "‚ùå –£–∫–∞–∂–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ!"; return; }
            if (fileInput.files.length === 0) { statusDiv.innerText = "‚ùå –ù—É–∂–Ω–æ —Ñ–æ—Ç–æ!"; return; }

            btn.disabled = true; btn.innerText = "‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..."; statusDiv.innerText = "";

            try {
                // 1. –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ –Ω–∞ ImgBB
                let formData = new FormData();
                formData.append("image", fileInput.files[0]);
                let response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData });
                let result = await response.json();

                if (!result.success) throw new Error("–û—à–∏–±–∫–∞ —Ñ–æ—Ç–æ");
                
                const photoUrl = result.data.url;

                // 2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–∞–∑—É –î–∞–Ω–Ω—ã—Ö Firebase
                const docRef = await addDoc(collection(db, "markers"), {
                    lat: selectedLat,
                    lng: selectedLng,
                    species: species,
                    date: date,
                    photo: photoUrl,
                    timestamp: new Date()
                });

                // 3. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –±–æ—Ç—É (—á—Ç–æ–±—ã –∞–¥–º–∏–Ω –∑–Ω–∞–ª)
                let dataToSend = {
                    type: "bumblebee_full_report",
                    lat: selectedLat, lng: selectedLng,
                    species: species, date: date, photo: photoUrl
                };
                tg.sendData(JSON.stringify(dataToSend));

            } catch (error) {
                statusDiv.innerText = "‚ùå –û—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ç—å."; 
                btn.disabled = false; btn.innerText = "–û–¢–ü–†–ê–í–ò–¢–¨ –ò –°–û–•–†–ê–ù–ò–¢–¨";
                console.error(error);
            }
        });
    </script>
</body>
</html>
